<!-- templates/peticiones/asistente_respuesta.html - CORREGIDO -->
{% extends 'base.html' %}

{% block title %}Asistente IA - {{ peticion.radicado }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-robot text-info"></i>
        Asistente IA para Respuesta
    </h1>
    <div>
        <a href="{% url 'detalle_peticion' peticion.radicado %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
</div>

<!-- Información de la Petición -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt"></i>
                    Petición: {{ peticion.radicado }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Peticionario:</strong> {{ peticion.peticionario_nombre|default:"Anónimo" }}</p>
                        <p><strong>Fecha:</strong> {{ peticion.fecha_radicacion|date:"d/m/Y H:i" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Estado:</strong> 
                            {% if peticion.estado == 'sin_responder' %}
                                <span class="badge bg-warning">{{ peticion.get_estado_display }}</span>
                            {% else %}
                                <span class="badge bg-success">{{ peticion.get_estado_display }}</span>
                            {% endif %}
                        </p>
                        <p><strong>Competencia:</strong> 
                            <span class="badge bg-info">{{ analisis.competencia_municipal|default:"A determinar" }}</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Análisis IA -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-brain"></i>
                    Análisis Inteligente del Documento
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Resumen de la Petición:</h6>
                        <p class="text-muted">{{ analisis.resumen_peticion }}</p>
                        
                        {% if analisis.aspectos_clave %}
                        <h6>Aspectos Clave Identificados:</h6>
                        <ul class="list-group list-group-flush">
                            {% for aspecto in analisis.aspectos_clave %}
                            <li class="list-group-item">
                                <i class="fas fa-check-circle text-success"></i> {{ aspecto }}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            {% if analisis.urgencia == 'alta' %}
                                <span class="badge bg-danger fs-6 p-3">
                                    <i class="fas fa-exclamation-triangle"></i> Urgencia Alta
                                </span>
                            {% elif analisis.urgencia == 'media' %}
                                <span class="badge bg-warning fs-6 p-3">
                                    <i class="fas fa-clock"></i> Urgencia Media
                                </span>
                            {% else %}
                                <span class="badge bg-success fs-6 p-3">
                                    <i class="fas fa-calendar-alt"></i> Urgencia Baja
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preguntas del Asistente -->
<div class="row">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle"></i>
                    Preguntas para Mejorar la Respuesta
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instrucciones:</strong> Responde las siguientes preguntas para que el asistente IA pueda generar una respuesta precisa y fundamentada legalmente.
                </div>
                
                <form id="formAsistente">
                    {% csrf_token %}
                    {% for pregunta in analisis.preguntas %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-question"></i>
                                Pregunta {{ forloop.counter }}
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="fw-bold">{{ pregunta.pregunta }}</p>
                            
                            {% if pregunta.justificacion %}
                            <p class="text-muted">
                                <i class="fas fa-lightbulb"></i>
                                <em>{{ pregunta.justificacion }}</em>
                            </p>
                            {% endif %}
                            
                            <!-- Opciones sugeridas si existen -->
                            {% if pregunta.opciones_sugeridas %}
                            <div class="mb-3">
                                <label class="form-label">Opciones sugeridas:</label>
                                {% for opcion in pregunta.opciones_sugeridas %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" 
                                           name="pregunta_{{ forloop.parentloop.counter }}_opcion" 
                                           id="opcion_{{ forloop.parentloop.counter }}_{{ forloop.counter }}"
                                           value="{{ opcion }}"
                                           onchange="actualizarRespuestaTexto({{ forloop.parentloop.counter }}, '{{ opcion }}')">
                                    <label class="form-check-label" for="opcion_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">
                                        {{ opcion }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Campo de respuesta libre -->
                            <div class="mb-3">
                                <label for="respuesta_{{ forloop.counter }}" class="form-label">
                                    Tu respuesta:
                                </label>
                                <textarea class="form-control" 
                                          id="respuesta_{{ forloop.counter }}" 
                                          name="respuesta_{{ forloop.counter }}"
                                          rows="3" 
                                          placeholder="Escribe tu respuesta detallada aquí..."
                                          required></textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success" id="btnGenerar">
                            <i class="fas fa-magic"></i> Generar Respuesta IA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Respuesta Generada -->
<div class="modal fade" id="modalRespuestaGenerada" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i>
                    Respuesta Generada por IA
                </h5>
            </div>
            <div class="modal-body">
                <!-- Evaluación de Calidad -->
                <div id="evaluacionCalidad" class="alert alert-info" style="display: none;">
                    <h6><i class="fas fa-chart-line"></i> Evaluación de Calidad</h6>
                    <div class="row">
                        <div class="col-md-6" id="puntuacionTotal"></div>
                        <div class="col-md-6" id="recomendacion"></div>
                    </div>
                </div>
                
                <!-- Respuesta Generada -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Respuesta Sugerida</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="copiarRespuesta()">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="respuestaGenerada" style="white-space: pre-wrap; font-family: 'Times New Roman', serif; line-height: 1.6;">
                            <!-- Aquí se mostrará la respuesta -->
                        </div>
                    </div>
                </div>
                
                <!-- Información adicional -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i>
                            Generada: <span id="fechaGeneracion"></span>
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">
                            <i class="fas fa-robot"></i>
                            Powered by Gemini AI
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="regenerarRespuesta()">
                    <i class="fas fa-redo"></i> Regenerar
                </button>
                <button type="button" class="btn btn-primary" onclick="mostrarModalDatosDescarga()">
                    <i class="fas fa-download"></i> Descargar Word
                </button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                    <i class="fas fa-check"></i> Finalizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Datos de Descarga -->
<div class="modal fade" id="modalDatosDescarga" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-word"></i>
                    Datos para el Documento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Complete los siguientes datos para generar el documento Word:</p>
                
                <div class="mb-3">
                    <label for="inputCiudad" class="form-label">
                        <i class="fas fa-map-marker-alt"></i> Ciudad
                        <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="inputCiudad" 
                           placeholder="Ej: Bogotá D.C." required>
                </div>
                
                <div class="mb-3">
                    <label for="inputNombreFuncionario" class="form-label">
                        <i class="fas fa-user-tie"></i> Nombre del Funcionario
                        <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="inputNombreFuncionario" 
                           placeholder="Ej: Juan Pérez García" required>
                </div>
                
                <div class="mb-3">
                    <label for="inputCargoFuncionario" class="form-label">
                        <i class="fas fa-briefcase"></i> Cargo del Funcionario
                        <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="inputCargoFuncionario" 
                           placeholder="Ej: Secretario de Gobierno" required>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <small>Estos datos se incluirán en el documento Word generado según la plantilla institucional.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="descargarRespuestaConDatos()">
                    <i class="fas fa-download"></i> Generar Documento
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let respuestasUsuario = [];

function actualizarRespuestaTexto(numeroPregunta, opcionSeleccionada) {
    const textarea = document.getElementById(`respuesta_${numeroPregunta}`);
    if (textarea.value.trim() === '') {
        textarea.value = opcionSeleccionada;
    }
}

document.getElementById('formAsistente').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Recopilar respuestas
    respuestasUsuario = [];
    const preguntas = {{ analisis.preguntas|safe }};
    
    preguntas.forEach((pregunta, index) => {
        const numeroPregunta = index + 1;
        const respuesta = document.getElementById(`respuesta_${numeroPregunta}`).value.trim();
        
        respuestasUsuario.push({
            pregunta: pregunta.pregunta,
            respuesta: respuesta
        });
    });
    
    // Validar que todas las preguntas tengan respuesta
    const respuestasVacias = respuestasUsuario.filter(r => r.respuesta === '');
    if (respuestasVacias.length > 0) {
        alert('Por favor responde todas las preguntas antes de continuar.');
        return;
    }
    
    // Mostrar loading en botón
    const btnGenerar = document.getElementById('btnGenerar');
    const textoOriginal = btnGenerar.innerHTML;
    btnGenerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando respuesta...';
    btnGenerar.disabled = true;
    
    // Enviar respuestas a la IA
    fetch(`/peticion/{{ peticion.radicado }}/asistente/procesar/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            respuestas: respuestasUsuario
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarRespuestaGenerada(data);
        } else {
            alert('Error: ' + (data.error || 'No se pudo generar la respuesta'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al generar la respuesta');
    })
    .finally(() => {
        btnGenerar.innerHTML = textoOriginal;
        btnGenerar.disabled = false;
    });
});

function mostrarRespuestaGenerada(data) {
    // Mostrar respuesta sin formato adicional
    document.getElementById('respuestaGenerada').textContent = data.respuesta_sugerida;
    document.getElementById('fechaGeneracion').textContent = data.fecha_generacion;
    
    // Mostrar evaluación si existe
    if (data.evaluacion) {
        const evaluacionDiv = document.getElementById('evaluacionCalidad');
        const puntuacionDiv = document.getElementById('puntuacionTotal');
        const recomendacionDiv = document.getElementById('recomendacion');
        
        puntuacionDiv.innerHTML = `<strong>Puntuación:</strong> ${data.evaluacion.puntuacion_total}/10`;
        recomendacionDiv.innerHTML = `<strong>Recomendación:</strong> ${data.evaluacion.recomendacion}`;
        
        evaluacionDiv.style.display = 'block';
    }
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalRespuestaGenerada'));
    modal.show();
}

function copiarRespuesta() {
    const respuesta = document.getElementById('respuestaGenerada').textContent;
    
    // Usar el API moderno de clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(respuesta).then(() => {
            mostrarNotificacionCopiado();
        }).catch(err => {
            console.error('Error al copiar:', err);
            copiarConFallback(respuesta);
        });
    } else {
        // Fallback para navegadores antiguos o contextos no seguros
        copiarConFallback(respuesta);
    }
}

function copiarConFallback(texto) {
    const textarea = document.createElement('textarea');
    textarea.value = texto;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
        const exitoso = document.execCommand('copy');
        if (exitoso) {
            mostrarNotificacionCopiado();
        } else {
            alert('No se pudo copiar el texto. Por favor, cópielo manualmente.');
        }
    } catch (err) {
        console.error('Error al copiar:', err);
        alert('Error al copiar al portapapeles');
    } finally {
        document.body.removeChild(textarea);
    }
}

function mostrarNotificacionCopiado() {
    const btn = document.querySelector('button[onclick="copiarRespuesta()"]');
    if (btn) {
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copiado';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = textoOriginal;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }
}

function regenerarRespuesta() {
    if (confirm('¿Estás seguro de regenerar la respuesta? Se perderá la respuesta actual.')) {
        document.getElementById('formAsistente').dispatchEvent(new Event('submit'));
    }
}

function mostrarModalDatosDescarga() {
    // Cerrar el modal de respuesta generada
    const modalRespuesta = bootstrap.Modal.getInstance(document.getElementById('modalRespuestaGenerada'));
    if (modalRespuesta) {
        modalRespuesta.hide();
    }
    
    // Mostrar el modal de datos de descarga
    const modalDatos = new bootstrap.Modal(document.getElementById('modalDatosDescarga'));
    modalDatos.show();
}

function descargarRespuestaConDatos() {
    const respuesta = document.getElementById('respuestaGenerada').textContent;
    const ciudad = document.getElementById('inputCiudad').value.trim();
    const nombreFuncionario = document.getElementById('inputNombreFuncionario').value.trim();
    const cargoFuncionario = document.getElementById('inputCargoFuncionario').value.trim();
    
    // Validar que todos los campos estén llenos
    if (!ciudad || !nombreFuncionario || !cargoFuncionario) {
        alert('Por favor complete todos los campos obligatorios.');
        return;
    }
    
    // Mostrar loading en botón
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
    btn.disabled = true;
    
    // Enviar solicitud para generar documento Word
    fetch(`/peticion/{{ peticion.radicado }}/asistente/descargar-word/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            contenido_respuesta: respuesta,
            ciudad: ciudad,
            nombre_funcionario: nombreFuncionario,
            cargo_funcionario: cargoFuncionario
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Error al generar el documento');
            });
        }
    })
    .then(blob => {
        // Crear enlace de descarga
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const fecha = new Date().toISOString().split('T')[0].replace(/-/g, '');
        a.download = `Respuesta_{{ peticion.radicado }}_${fecha}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Cerrar modal de datos
        const modalDatos = bootstrap.Modal.getInstance(document.getElementById('modalDatosDescarga'));
        if (modalDatos) {
            modalDatos.hide();
        }
        
        // Limpiar campos
        document.getElementById('inputCiudad').value = '';
        document.getElementById('inputNombreFuncionario').value = '';
        document.getElementById('inputCargoFuncionario').value = '';
        
        // Mostrar mensaje de éxito
        alert('Documento Word generado exitosamente');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al descargar el documento Word: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
    });
}
</script>
{% endblock %}